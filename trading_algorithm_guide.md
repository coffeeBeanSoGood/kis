# 🤖 신호 기반 자동매매 시스템 완벽 가이드

**초보자를 위한 매수·매도 알고리즘 상세 설명서**

---

## 📑 목차

1. [시스템 개요](#1-시스템-개요)
2. [전체 프로세스 흐름도](#2-전체-프로세스-흐름도)
3. [대상 종목 (41개)](#3-대상-종목-41개)
4. [신호 생성 시스템](#4-신호-생성-시스템)
5. [매수 알고리즘](#5-매수-알고리즘)
6. [매도 알고리즘](#6-매도-알고리즘)
7. [실전 시나리오](#7-실전-시나리오)
8. [주요 설정값](#8-주요-설정값)
9. [FAQ](#9-faq)

---

## 1. 시스템 개요

### 🎯 시스템 구조

```
┌─────────────────────────────────────────────────────────────┐
│                  신호 기반 자동매매 시스템                   │
└─────────────────────────────────────────────────────────────┘

┌──────────────────────┐        ┌──────────────────────┐
│  SignalMonitor_KR    │        │ Kiwoom_SignalBot     │
│  (신호 생성기)        │───────▶│  (자동매매 봇)        │
│                      │  신호   │                      │
│  • 41개 종목 분석    │  전달   │  • 매수 실행         │
│  • 5가지 지표 평가   │        │  • 매도 실행         │
│  • 점수화 (0-100점)  │        │  • 수익 관리         │
└──────────────────────┘        └──────────────────────┘
         ↓                               ↓
   signal_history.json            trading_positions.json
```

### ✨ 핵심 특징

- ✅ **41개 종목** 실시간 모니터링 (6개 섹터)
- ✅ **5가지 지표** 종합 분석
- ✅ **신호 검증** 시스템 (3회 중 2회 일치)
- ✅ **실시간 감지** (watchdog, 0초 지연)
- ✅ **스마트 매도** (3단계 수익 보호)
- ✅ **리스크 관리** (예산, 쿨다운, 손절)

---

## 2. 전체 프로세스 흐름도

### 📊 전체 흐름

```
┌────────────────────────────────────────────────────────────┐
│                    1️⃣ 신호 생성 단계                        │
│                   (SignalMonitor_KR.py)                    │
└────────────────────────────────────────────────────────────┘
                            ↓
       ┌───────────────────────────────────────┐
       │ 5분마다 41개 종목 순차 분석            │
       │ • 호가 분석 (매수/매도 호가 비율)      │
       │ • 체결강도 (거래 압력)                │
       │ • 외국인/기관 (수급)                  │
       │ • 현재가/거래량 (가격 모멘텀)          │
       │ • 추세 분석 (이동평균, RSI)           │
       └───────────────────────────────────────┘
                            ↓
       ┌───────────────────────────────────────┐
       │ 점수 계산 (0-100점)                   │
       │ • 각 지표별 점수 산출                 │
       │ • 가중치 적용 (외국인 25%)            │
       │ • 신뢰도 평가 (40% 미만 제외)         │
       └───────────────────────────────────────┘
                            ↓
       ┌───────────────────────────────────────┐
       │ 신호 등급 결정                        │
       │ • 75점 이상: STRONG_BUY 🔥           │
       │ • 60-74점: BUY 📈                    │
       │ • 40-59점: HOLD ⏸️                   │
       │ • 25-39점: SELL ⚠️                  │
       │ • 24점 이하: STRONG_SELL 🚨         │
       └───────────────────────────────────────┘
                            ↓
       ┌───────────────────────────────────────┐
       │ 신호 검증 (NEW!)                      │
       │ • 안정성: 최근 3회 중 2회 일치        │
       │ • 시장 필터: 급락 시 경고             │
       │ • 중복 제거: 같은 신호 반복 차단      │
       └───────────────────────────────────────┘
                            ↓
       ┌───────────────────────────────────────┐
       │ signal_history.json 저장               │
       │ [{종목코드, 신호, 점수, 시간, ...}]    │
       └───────────────────────────────────────┘

┌────────────────────────────────────────────────────────────┐
│                    2️⃣ 매매 실행 단계                        │
│                  (Kiwoom_SignalTradingBot.py)              │
└────────────────────────────────────────────────────────────┘
                            ↓
       ┌───────────────────────────────────────┐
       │ watchdog가 파일 변경 즉시 감지         │
       │ • 0.5초 대기 (파일 쓰기 완료)         │
       │ • 신호 파일 읽기                      │
       └───────────────────────────────────────┘
                            ↓
       ┌───────────────────────────────────────┐
       │ 유효 신호 필터링                      │
       │ • 10분 이내 신호만 유효               │
       │ • 신뢰도 40% 이상                     │
       │ • STRONG_BUY 신호만 매수              │
       └───────────────────────────────────────┘
                            ↓
            ┌──────────────────────┐
            │  매수 신호 있음?      │
            └──────────────────────┘
                    ↓ YES              ↓ NO
       ┌──────────────────┐    ┌──────────────────┐
       │  3️⃣ 매수 실행    │    │  4️⃣ 매도 체크    │
       └──────────────────┘    └──────────────────┘

┌────────────────────────────────────────────────────────────┐
│                    3️⃣ 매수 실행 프로세스                    │
└────────────────────────────────────────────────────────────┘
                            ↓
       ┌───────────────────────────────────────┐
       │ 매수 가능 여부 체크                   │
       │ ❌ 이미 보유 중?                      │
       │ ❌ 쿨다운 중? (24시간)                │
       │ ❌ 최대 종목 수 도달? (3개)           │
       │ ❌ 예산 부족? (50만원/일)             │
       └───────────────────────────────────────┘
                            ↓ 모두 통과
       ┌───────────────────────────────────────┐
       │ 현재가 조회                           │
       │ • 키움 API 호출                       │
       │ • 호가 단위 조정 (유리하게 내림)      │
       └───────────────────────────────────────┘
                            ↓
       ┌───────────────────────────────────────┐
       │ 매수 수량 계산                        │
       │ 예: 50만원 ÷ 50,000원 = 10주         │
       └───────────────────────────────────────┘
                            ↓
       ┌───────────────────────────────────────┐
       │ 지정가 매수 주문 발송                 │
       │ • 키움 API: MakeBuyLimitOrder        │
       │ • 주문번호 수신                       │
       └───────────────────────────────────────┘
                            ↓
       ┌───────────────────────────────────────┐
       │ pending_orders.json 등록               │
       │ • 미체결 주문으로 등록                │
       │ • 5분 타임아웃 설정                   │
       │ • 자동 관리 시작                      │
       └───────────────────────────────────────┘
                            ↓
       ┌───────────────────────────────────────┐
       │ 체결 확인 (백그라운드)                │
       │ • 30초마다 체결 여부 확인             │
       │ • 체결 시: positions.json 등록        │
       │ • 미체결 5분 초과: 취소 후 재주문     │
       └───────────────────────────────────────┘

┌────────────────────────────────────────────────────────────┐
│                    4️⃣ 매도 실행 프로세스                    │
└────────────────────────────────────────────────────────────┘
                            ↓
       ┌───────────────────────────────────────┐
       │ 보유 종목 순회 체크                   │
       │ (30초마다 백그라운드)                 │
       └───────────────────────────────────────┘
                            ↓
       ┌───────────────────────────────────────┐
       │ 매도 조건 체크 (우선순위 순)          │
       │                                       │
       │ 1️⃣ 목표 수익 달성? (+3%)             │
       │    ✅ 즉시 매도                       │
       │                                       │
       │ 2️⃣ 트레일링 스탑 발동?               │
       │    ✅ 즉시 매도                       │
       │                                       │
       │ 3️⃣ 손절 신호? (SELL/STRONG_SELL)    │
       │    ✅ 즉시 매도                       │
       │                                       │
       │ 4️⃣ 긴급 손절? (-3%)                  │
       │    ✅ 즉시 매도                       │
       └───────────────────────────────────────┘
                            ↓ 매도 조건 만족
       ┌───────────────────────────────────────┐
       │ 매도 주문 발송                        │
       │ • 지정가 매도 (유리하게 올림)         │
       │ • 수익/손실 계산                      │
       └───────────────────────────────────────┘
                            ↓
       ┌───────────────────────────────────────┐
       │ 매도 완료 처리                        │
       │ • positions.json 삭제                 │
       │ • cooldowns.json 등록 (24시간)        │
       │ • 실현 손익 기록                      │
       │ • 성과 통계 업데이트                  │
       └───────────────────────────────────────┘
```

---

## 3. 대상 종목 (41개)

### 📊 섹터별 종목 구성

#### 🔋 2차전지 섹터 (8종목)

| 종목명 | 코드 | 특징 | 비고 |
|--------|------|------|------|
| 에코프로 | 086520 | 양극재 1위 | 고변동성 |
| POSCO홀딩스 | 005490 | 소재 대형주 | 안정적 |
| 삼성SDI | 006400 | 배터리 2위 | 대형주 |
| LG에너지솔루션 | 373220 | 배터리 1위 | 대형주 |
| 엔켐 | 348370 | 2차전지 소재 | 중형주 |
| 대주전자재료 | 078600 | 전해액 | 중소형주 |
| TIGER 2차전지소재Fn | 305720 | ETF | 분산투자 |
| 성일하이텍 | 365340 | 배터리 장비 | 중소형주 |

#### 🔥 LNG 섹터 (2종목)

| 종목명 | 코드 | 특징 |
|--------|------|------|
| 동성화인텍 | 033500 | LNG 운반선 |
| 한국카본 | 017960 | 탄소섬유 |

#### 🚢 조선 섹터 (2종목)

| 종목명 | 코드 | 특징 |
|--------|------|------|
| 한화오션 | 042660 | 조선 1위 |
| 삼성중공업 | 010140 | 조선 2위 |

#### ⚡ 원전 섹터 (6종목)

| 종목명 | 코드 | 특징 |
|--------|------|------|
| 우진 | 105840 | 원전 기자재 |
| 우진엔텍 | 041960 | 원전 부품 |
| 일진파워 | 094820 | 전력 기자재 |
| 두산에너빌리티 | 034020 | 원전 대형주 |
| 현대건설 | 000720 | 원전 건설 |
| 한전KPS | 051600 | 원전 유지보수 |

#### 🚀 방산 섹터 (6종목)

| 종목명 | 코드 | 특징 |
|--------|------|------|
| 한화시스템 | 272210 | 방산 전자 |
| 현대로템 | 064350 | 장갑차 |
| LIG넥스원 | 079550 | 유도무기 |
| PLUS K방산 | 281990 | 방산 ETF |
| 한국항공우주 | 047810 | 항공기 |
| 풍산 | 103140 | 방산 소재 |

#### 🤖 로봇 섹터 (8종목)

| 종목명 | 코드 | 특징 |
|--------|------|------|
| 원익홀딩스 | 030530 | 반도체 장비 |
| 에스피지 | 058610 | 디스플레이 |
| 클로봇 | 182690 | 자율주행 |
| 로보티즈 | 108490 | 교육 로봇 |
| 두산로보틱스 | 454910 | 협동로봇 |
| 케이엔알시스템 | 399720 | 로봇 부품 |
| 씨메스 | 140860 | 반도체 검사 |
| 유진로봇 | 056080 | 협동로봇 선두 |

#### 💾 반도체 섹터 (9종목)

| 종목명 | 코드 | 특징 |
|--------|------|------|
| 삼성전자 | 005930 | 메모리 1위 |
| SK하이닉스 | 000660 | 메모리 2위 |
| DB하이텍 | 000990 | 파운드리 |
| 유진테크 | 084370 | 반도체 장비 |
| 원익IPS | 240810 | 반도체 장비 |
| 테스 | 095610 | 반도체 검사 |
| 에스엔유 | 046890 | 반도체 부품 |
| SFA반도체 | 036540 | 반도체 소재 |
| 솔브레인 | 357780 | 반도체 소재 |

### 💡 종목 선정 기준

1. **유동성**: 일평균 거래대금 100억원 이상
2. **섹터 대표성**: 각 섹터의 대표 종목
3. **기관 관심도**: 외국인·기관 순매수 빈도
4. **성장성**: 업종 전망 긍정적
5. **API 지원**: 키움증권 API 안정성

---

## 4. 신호 생성 시스템

### 📈 5가지 분석 지표

#### 1️⃣ 호가 분석 (가중치 20%)

**측정 항목:**
- 매수 호가 잔량 합계
- 매도 호가 잔량 합계
- 매수/매도 비율

**점수 산출:**
```
매수 우세도 = (매수 호가량 - 매도 호가량) / 전체 호가량 × 100

점수 매핑:
• 70% 이상 매수 우세 → 100점
• 60-69% → 80점
• 50-59% → 60점 (균형)
• 40-49% → 40점
• 40% 미만 매도 우세 → 20점
```

**해석:**
- 🔥 **매수 호가 > 70%**: 강력한 매수 수요
- ✅ **60-70%**: 매수 우위
- ⚠️ **40% 미만**: 매도 압력

#### 2️⃣ 체결강도 (가중치 20%)

**측정 항목:**
- 최근 체결 건수 (매수/매도 구분)
- 체결강도 = (매수 체결량 / 매도 체결량) × 100

**점수 산출:**
```
• 150% 이상 → 100점 (매우 강한 매수)
• 120-149% → 80점
• 100-119% → 60점 (균형)
• 80-99% → 40점
• 80% 미만 → 20점 (매도 우세)
```

**해석:**
- 🔥 **150% 이상**: 폭발적 매수세
- ✅ **120-149%**: 강한 매수
- ⚠️ **80% 미만**: 매도 우세

#### 3️⃣ 외국인/기관 (가중치 25%) ⭐ 최고 비중

**측정 항목:**
- 외국인 순매수량
- 기관 순매수량
- 거래량 대비 비율

**점수 산출:**
```
외국인·기관 점수 = (순매수량 / 거래량) × 100

동반 순매수 시 가산점:
• 외국인 + 기관 동시 매수 → 100점
• 한쪽만 순매수 → 70점
• 둘 다 순매도 → 20점
```

**해석:**
- 🔥 **동반 순매수**: 최고 신호
- ✅ **한쪽만 순매수**: 긍정적
- ⚠️ **동반 순매도**: 부정적

#### 4️⃣ 현재가/거래량 (가중치 20%)

**측정 항목:**
- 등락률
- 거래량 증가율
- 가격 모멘텀

**점수 산출:**
```
• 상승 + 거래량 급증 → 100점
• 상승 + 평균 거래량 → 70점
• 보합 → 50점
• 하락 + 평균 거래량 → 30점
• 급락 + 거래량 급증 → 0점
```

#### 5️⃣ 추세 분석 (가중치 15%)

**측정 항목:**
- 5일/20일/60일 이동평균
- RSI (14일)
- 분봉 추세 (5분, 10분, 30분)

**점수 산출:**
```
정배열 + RSI 50-70 → 100점
정배열 + RSI 30-50 → 80점
이평선 혼재 → 50점
역배열 + RSI 30-50 → 30점
역배열 + RSI 70 이상 → 20점
```

### 🎯 최종 점수 계산

```python
최종점수 = (호가×0.2) + (체결강도×0.2) + (외국인기관×0.25) 
          + (현재가×0.2) + (추세×0.15)

신뢰도 = (수집 성공한 지표 개수 / 5) × 100%

예시:
호가: 90점, 체결강도: 85점, 외국인기관: 95점, 
현재가: 80점, 추세: 70점

최종점수 = 90×0.2 + 85×0.2 + 95×0.25 + 80×0.2 + 70×0.15
        = 18 + 17 + 23.75 + 16 + 10.5
        = 85.25점 → STRONG_BUY 🔥

신뢰도 = 5/5 = 100% (모든 지표 수집 성공)
```

### 📊 신호 등급 체계

| 점수 범위 | 신호 | 의미 | 권장 행동 |
|-----------|------|------|-----------|
| 75-100점 | 🔥 STRONG_BUY | 강력 매수 | **즉시 매수** |
| 60-74점 | 📈 BUY | 매수 | 매수 고려 |
| 40-59점 | ⏸️ HOLD | 보유 | 관망 |
| 25-39점 | ⚠️ SELL | 매도 | 매도 고려 |
| 0-24점 | 🚨 STRONG_SELL | 강력 매도 | 즉시 매도 |

### ✅ 신호 검증 시스템 (NEW!)

#### 1️⃣ 안정성 검증

**규칙:** 최근 3회 중 2회 이상 같은 신호

```
예시 1: 안정적 신호 ✅
09:05 - STRONG_BUY (78점)
09:10 - STRONG_BUY (81점)  ← 2회 일치
09:15 - BUY (68점)

→ 신뢰도 유지 (85%)
→ "✅ 신호 안정 (3회 중 2회)"

예시 2: 불안정 신호 ⚠️
09:05 - STRONG_BUY (76점)
09:10 - HOLD (58점)
09:15 - BUY (65점)

→ 신뢰도 30% 감소 (85% → 59%)
→ "⚠️ 신호 불안정 (혼재: HOLD, BUY)"
→ 알림 차단!
```

#### 2️⃣ 시장 상황 필터

**규칙:** 코스피 또는 코스닥 -2% 이상 급락 시 경고

```
정상 시장:
코스피: +0.8% ✅
코스닥: +1.2% ✅
→ 신호 그대로 전달

급락 시장:
코스피: -3.5% 🚨
코스닥: -4.2% 🚨
→ 매수 신호에 경고 추가
→ "🚨 시장 급락 - 매수 주의"
```

---

## 5. 매수 알고리즘

### 🎯 매수 프로세스 상세

#### Step 1: 신호 수신 (Watchdog)

```python
# watchdog가 signal_history.json 변경 감지
# → 0.5초 대기 (파일 쓰기 완료)
# → 파일 읽기 → 신호 처리
```

#### Step 2: 유효 신호 필터링

```python
필터 조건:
1. 시간: 10분 이내 신호만 유효
2. 신뢰도: 40% 이상
3. 신호 타입: STRONG_BUY만 (설정 가능)

예시:
현재 시각: 10:15
신호 발생: 10:10 (5분 전) → ✅ 유효
신호 발생: 10:03 (12분 전) → ❌ 만료
신호 신뢰도: 38% → ❌ 제외
신호: BUY → ❌ STRONG_BUY만 매수
```

#### Step 3: 매수 가능 여부 체크

```python
체크 항목 (하나라도 실패 시 매수 중단):

1️⃣ 이미 보유 중?
   - positions.json 확인
   - pending_orders.json 확인
   - 있으면 → ❌ 스킵

2️⃣ 쿨다운 중? (24시간)
   - cooldowns.json 확인
   - 마지막 매도 후 24시간 미경과 → ❌ 스킵
   - 이유: 같은 종목 반복 매매 방지

3️⃣ 최대 종목 수 도달? (3개)
   - 보유 + 미체결 주문 합계
   - 3개 이상 → ❌ 스킵
   - 이유: 분산 투자 제한

4️⃣ 예산 부족? (50만원/일)
   - 일일 예산: 500,000원
   - 사용 예산 = 보유 중 + 미체결 주문
   - 잔여 < 100,000원 → ❌ 스킵
```

#### Step 4: 매수 주문 실행

```python
1. 현재가 조회
   - KiwoomAPI.GetStockInfo(종목코드)
   - 현재가: 50,000원

2. 호가 단위 조정 (유리하게 내림)
   가격대별 호가 단위:
   • 1,000원 미만: 1원
   • 1,000-5,000원: 5원
   • 5,000-10,000원: 10원
   • 10,000-50,000원: 50원
   • 50,000-100,000원: 100원
   
   예: 50,230원 → 50,200원 (100원 단위 내림)

3. 매수 수량 계산
   예산: 500,000원
   가격: 50,200원
   수량: 500,000 ÷ 50,200 = 9.96주 → 9주
   실제 금액: 50,200 × 9 = 451,800원

4. 지정가 매수 주문
   - KiwoomAPI.MakeBuyLimitOrder(종목코드, 9주, 50,200원)
   - 주문번호 수신: "20260127-001"

5. pending_orders.json 등록
   {
     "005930": {
       "order_no": "20260127-001",
       "stock_name": "삼성전자",
       "order_type": "buy",
       "order_price": 50200,
       "order_quantity": 9,
       "order_time": "2026-01-27 10:15:30",
       "timeout_minutes": 5,
       "retry_count": 0
     }
   }
```

#### Step 5: 체결 관리 (백그라운드)

```python
30초마다 자동 실행:

1. 미체결 주문 조회
   - KiwoomAPI.GetPendingOrders()

2. 체결 확인
   체결됨:
   - positions.json 등록
   - pending_orders.json 삭제
   - 디스코드 알림: "✅ 매수 체결!"
   
   {
     "005930": {
       "stock_name": "삼성전자",
       "entry_price": 50200,
       "quantity": 9,
       "entry_time": "2026-01-27 10:16:05",
       "highest_price": 50200,
       "trailing_stop_price": 0,
       "breakeven_protected": false,
       "tight_trailing_active": false
     }
   }

3. 타임아웃 체크 (5분 초과)
   미체결 5분 초과:
   - 기존 주문 취소
   - 현재가 재조회
   - 호가 조정 후 재주문
   - 재시도 횟수: 최대 3회
   
   3회 실패:
   - 주문 포기
   - pending_orders.json 삭제
   - 로그: "❌ 매수 실패 (3회 시도)"
```

### 💡 매수 예시

#### 시나리오 1: 성공적인 매수

```
10:10:00 - SignalMonitor: 삼성전자 STRONG_BUY 신호 발생 (81점)
          → signal_history.json 저장

10:10:01 - watchdog: 파일 변경 감지
          → 0.5초 대기

10:10:02 - TradingBot: 신호 읽기
          → 유효 신호 확인
          → 매수 가능 체크: ✅ 모두 통과

10:10:03 - 현재가 조회: 50,230원
          → 호가 조정: 50,200원
          → 수량 계산: 9주 (451,800원)

10:10:04 - 매수 주문 발송
          → 주문번호: 20260127-001
          → pending_orders 등록

10:10:35 - 체결 확인 (30초 후)
          → 미체결 확인

10:11:05 - 체결 확인 (1분 후)
          → ✅ 체결 완료!
          → positions 등록
          → 디스코드 알림: "✅ 삼성전자 매수 체결!"
```

#### 시나리오 2: 매수 불가 (쿨다운)

```
10:10:00 - SignalMonitor: 한화오션 STRONG_BUY 신호
10:10:02 - TradingBot: 쿨다운 체크
          → cooldowns.json 확인
          → 마지막 매도: 어제 15:20 (19시간 전)
          → ❌ 24시간 미경과
          → 로그: "⏰ 한화오션 쿨다운 중 (5시간 남음)"
          → 매수 스킵
```

---

## 6. 매도 알고리즘

### 🎯 3단계 수익 보호 시스템

#### 📊 구간별 전략

```
수익률 구간에 따른 단계별 보호:

┌─────────────────────────────────────────┐
│  -3%   │  0%  │  +2%  │  +3%  │  +5%  │
└─────────────────────────────────────────┘
    🚨      ⏸️     🛡️      🎯      🔥
  긴급손절  대기  본전보호  타이트  목표
```

#### 1️⃣ 일반 구간 (0% ~ +2%)

**상태:** 대기 모드
**트레일링:** -1% (일반)

```
예시:
진입가: 50,000원
현재가: 50,800원 (+1.6%)
최고가: 50,800원
트레일링: 50,800 × 0.99 = 50,292원 (-1%)

→ 50,292원 이하로 떨어지면 매도
→ 손절가: 50,292원
→ 보장 수익: +0.58%
```

#### 2️⃣ 본전 보호 구간 (+2% ~ +3%)

**상태:** 🛡️ 본전 보호 활성화
**트레일링:** 진입가 고정

```
예시:
진입가: 50,000원
현재가: 51,100원 (+2.2%)
최고가: 51,100원
트레일링: 50,000원 (본전)

→ 50,000원 이하로 떨어지면 매도
→ 손절가: 50,000원
→ 보장 수익: ±0% (본전 보호)

디스코드 알림:
"🛡️ 본전 보호 활성화!
진입가: 50,000원
현재가: 51,100원 (+2.2%)
손절선: 50,000원 (본전 보호)"
```

#### 3️⃣ 타이트 트레일링 구간 (+3% 이상)

**상태:** 🎯 타이트 트레일링 활성화
**트레일링:** -0.5% (매우 촘촘)

```
예시:
진입가: 50,000원
현재가: 51,600원 (+3.2%)
최고가: 51,600원
트레일링: 51,600 × 0.995 = 51,342원 (-0.5%)

→ 51,342원 이하로 떨어지면 매도
→ 손절가: 51,342원
→ 보장 수익: +2.68%

디스코드 알림:
"🎯 타이트 트레일링 시작!
진입가: 50,000원
최고가: 51,600원 (+3.2%)
트레일링: 51,342원 (-0.5%)"

이후 최고가 갱신 시:
현재가: 52,000원 (+4.0%)
최고가: 52,000원 (갱신!)
트레일링: 52,000 × 0.995 = 51,740원

→ 보장 수익: +3.48%
```

### 🎯 매도 조건 (우선순위 순)

#### 1️⃣ 목표 수익 달성 (+3%)

```python
if 수익률 >= 3%:
    → 즉시 매도
    → 사유: "목표 수익 달성 (+3.2%)"

예시:
진입가: 50,000원
현재가: 51,600원
수익률: +3.2%

→ ✅ 즉시 매도
→ 실현 수익: 1,600원 × 9주 = 14,400원
```

#### 2️⃣ 트레일링 스탑 발동

```python
if 현재가 <= 트레일링 스탑 가격:
    → 즉시 매도
    → 사유: "트레일링 스탑 발동 (보장수익: +2.5%)"

예시:
진입가: 50,000원
최고가: 52,000원 (+4.0%)
트레일링: 51,740원 (-0.5%)
현재가: 51,700원 (하락!)

→ 51,700 <= 51,740 → ✅ 매도
→ 실현 수익: 51,700 - 50,000 = 1,700원 × 9주 = 15,300원
→ 수익률: +3.4%
```

#### 3️⃣ 손절 신호 (SELL/STRONG_SELL)

```python
if 신호 in ["SELL", "STRONG_SELL"] and 신뢰도 >= 40%:
    → 즉시 매도
    → 사유: "손절 신호 (STRONG_SELL, 신뢰도: 75%)"

예시:
10:25 - 보유 중: 삼성전자 (+1.5%)
10:30 - SignalMonitor: STRONG_SELL 신호 발생 (30점, 신뢰도 75%)
      → watchdog 감지
      → 매도 조건 체크
      → ✅ 손절 신호 확인
      → 즉시 매도 주문
```

#### 4️⃣ 긴급 손절 (-3%)

```python
if 수익률 <= -3%:
    → 즉시 매도
    → 사유: "긴급 손절 (-3.2%)"
    → 경고 로그

예시:
진입가: 50,000원
현재가: 48,400원
수익률: -3.2%

→ 🚨 긴급 손절 발동
→ 실현 손실: -1,600원 × 9주 = -14,400원
```

### 💸 매도 실행 프로세스

```python
1. 현재가 조회
   - 50,200원

2. 호가 단위 조정 (유리하게 올림)
   - 50,200원 → 50,300원 (100원 단위 올림)

3. 수익 계산
   진입가: 50,000원
   매도가: 50,300원
   수량: 9주
   
   매수 금액: 50,000 × 9 = 450,000원
   매수 수수료: 450,000 × 0.015% = 68원
   
   매도 금액: 50,300 × 9 = 452,700원
   매도 수수료: 452,700 × 0.015% = 68원
   매도 세금: 452,700 × 0.23% = 1,041원
   
   실현 수익: 452,700 - 450,000 - 68 - 68 - 1,041
           = 1,523원
   수익률: +0.34%

4. 지정가 매도 주문
   - KiwoomAPI.MakeSellLimitOrder(종목코드, 9주, 50,300원)

5. pending_orders 등록
   - 미체결 관리 시작

6. 체결 완료 처리
   - positions 삭제
   - cooldowns 등록 (24시간)
   - 성과 기록
   
   cooldowns.json:
   {
     "005930": {
       "stock_name": "삼성전자",
       "sell_time": "2026-01-27 14:30:15",
       "cooldown_until": "2026-01-28 14:30:15",
       "sell_reason": "목표 수익 달성 (+3.2%)",
       "entry_price": 50000,
       "sell_price": 50300,
       "profit": 1523,
       "profit_rate": 0.34%
     }
   }
```

### 💡 매도 예시

#### 시나리오 1: 목표 수익 달성

```
10:15 - 매수 체결: 50,000원 × 9주
10:45 - 현재가: 51,500원 (+3.0%)
      → 매도 조건 체크
      → ✅ 목표 수익 달성 (+3.0%)
      → 매도 주문: 51,500원
11:15 - 매도 체결: 51,500원
      → 실현 수익: +1,350원 (+2.7%)
      → 디스코드 알림: "🎉 목표 수익 달성!"
```

#### 시나리오 2: 트레일링 스탑

```
10:15 - 매수: 50,000원
10:30 - 현재가: 51,000원 (+2.0%)
      → 🛡️ 본전 보호 활성화
      → 트레일링: 50,000원

10:45 - 현재가: 51,600원 (+3.2%)
      → 🎯 타이트 트레일링 활성화
      → 트레일링: 51,342원 (-0.5%)

11:00 - 현재가: 52,200원 (+4.4%)
      → 최고가 갱신
      → 트레일링: 51,939원

11:15 - 현재가: 51,900원 (하락)
      → 51,900 <= 51,939
      → ✅ 트레일링 스탑 발동
      → 매도 주문: 51,900원

11:45 - 매도 체결: 51,900원
      → 실현 수익: +1,710원 (+3.8%)
      → 디스코드: "📉 트레일링 스탑 (보장수익: +3.8%)"
```

#### 시나리오 3: 손절 신호

```
10:15 - 매수: 50,000원
10:30 - 현재가: 50,600원 (+1.2%)

10:45 - SignalMonitor: STRONG_SELL 신호 (20점, 신뢰도 80%)
      → watchdog 감지
      → 매도 조건 체크
      → ✅ 손절 신호 확인
      → 매도 주문: 50,500원

11:15 - 매도 체결: 50,500원
      → 실현 수익: +450원 (+1.0%)
      → 디스코드: "⚠️ 손절 신호 매도 (STRONG_SELL)"
```

---

## 7. 실전 시나리오

### 📈 시나리오 1: 이상적인 매매

```
09:05 - SignalMonitor 시작
      - 41개 종목 분석 시작

09:10 - 삼성전자 분석 완료
      - 호가: 90점 (매수 72%)
      - 체결강도: 85점 (142%)
      - 외국인/기관: 95점 (동반 순매수)
      - 현재가: 80점 (+2.1%)
      - 추세: 70점 (정배열)
      - 최종: 85.25점 → STRONG_BUY 🔥
      - 신뢰도: 100% (5개 지표)
      - 안정성: ✅ 신호 안정 (3회 중 2회)

09:10:30 - signal_history.json 저장
         - watchdog 즉시 감지

09:10:31 - TradingBot 처리
         - 유효 신호 확인: ✅
         - 매수 가능 체크: ✅
         - 현재가: 50,230원 → 50,200원
         - 수량: 9주 (451,800원)
         - 매수 주문 발송

09:11:05 - 매수 체결 완료
         - 진입가: 50,200원
         - 디스코드: "✅ 삼성전자 매수 체결!"

09:30 - 현재가: 51,000원 (+1.6%)
      - 트레일링: 50,490원 (-1%)

09:45 - 현재가: 51,100원 (+1.8%)
      - 트레일링: 50,589원

10:00 - 현재가: 51,300원 (+2.2%)
      - 🛡️ 본전 보호 활성화
      - 트레일링: 50,200원 (본전)

10:15 - 현재가: 51,600원 (+2.8%)
      - 트레일링: 50,200원 유지

10:30 - 현재가: 51,700원 (+3.0%)
      - ✅ 목표 수익 달성!
      - 매도 주문: 51,800원

10:45 - 매도 체결 완료
      - 매도가: 51,800원
      - 실현 수익: +14,400원 (+3.19%)
      - 디스코드: "🎉 목표 수익 달성!"
      - 쿨다운 등록: 24시간

총 소요 시간: 1시간 35분
실현 수익률: +3.19%
```

### 📉 시나리오 2: 손절 후 재진입

```
09:10 - 한화오션 STRONG_BUY
      - 매수: 42,000원 × 11주

09:30 - 현재가: 41,500원 (-1.2%)
      - 트레일링: 41,085원 (-1%)

09:45 - SignalMonitor: SELL 신호 (35점)
      - watchdog 감지
      - ✅ 손절 신호 확인
      - 매도 주문: 41,400원

10:00 - 매도 체결
      - 실현 손실: -6,600원 (-1.43%)
      - 쿨다운 시작: 24시간

--- 다음 날 ---

10:15 - 한화오션 STRONG_BUY (82점)
      - 쿨다운 체크: ✅ 24시간 경과
      - 매수: 41,200원 × 12주

11:00 - 현재가: 42,500원 (+3.2%)
      - 🎯 타이트 트레일링 활성화
      - 트레일링: 42,287원

11:30 - 현재가: 42,900원 (+4.1%)
      - 최고가 갱신
      - 트레일링: 42,685원

12:00 - 현재가: 42,600원 (하락)
      - 42,600 <= 42,685
      - ✅ 트레일링 스탑 발동
      - 매도: 42,600원

12:15 - 매도 체결
      - 실현 수익: +16,800원 (+3.40%)

결과: 첫 손실 만회 + 수익 실현
```

---

## 8. 주요 설정값

### ⚙️ 매수 설정

```json
{
  "buy_signals": ["STRONG_BUY"],
  "signal_validity_minutes": 10,
  "min_signal_confidence": 0.4,
  "daily_budget": 500000,
  "max_positions": 3,
  "min_buy_amount": 100000
}
```

| 항목 | 기본값 | 설명 |
|------|--------|------|
| buy_signals | STRONG_BUY | 매수 대상 신호 |
| signal_validity_minutes | 10분 | 신호 유효 시간 |
| min_signal_confidence | 40% | 최소 신뢰도 |
| daily_budget | 50만원 | 일일 투자 예산 |
| max_positions | 3개 | 최대 보유 종목 |
| min_buy_amount | 10만원 | 최소 매수 금액 |

### ⚙️ 매도 설정

```json
{
  "target_profit_rate": 0.03,
  "breakeven_protection_rate": 0.02,
  "tight_trailing_threshold": 0.03,
  "tight_trailing_rate": 0.005,
  "trailing_stop_rate": 0.01,
  "emergency_stop_loss": -0.03,
  "sell_signals": ["SELL", "STRONG_SELL"]
}
```

| 항목 | 기본값 | 설명 |
|------|--------|------|
| target_profit_rate | 3% | 목표 수익률 |
| breakeven_protection_rate | 2% | 본전 보호 시작 |
| tight_trailing_threshold | 3% | 타이트 트레일링 시작 |
| tight_trailing_rate | 0.5% | 타이트 트레일링 폭 |
| trailing_stop_rate | 1% | 일반 트레일링 폭 |
| emergency_stop_loss | -3% | 긴급 손절선 |
| sell_signals | SELL, STRONG_SELL | 손절 신호 |

### ⚙️ 운영 설정

```json
{
  "cooldown_hours": 24,
  "pending_order_timeout_minutes": 5,
  "check_pending_interval_seconds": 30,
  "check_position_interval_seconds": 30,
  "max_retry_count": 3
}
```

| 항목 | 기본값 | 설명 |
|------|--------|------|
| cooldown_hours | 24시간 | 재진입 금지 기간 |
| pending_order_timeout_minutes | 5분 | 미체결 타임아웃 |
| check_pending_interval_seconds | 30초 | 미체결 확인 주기 |
| check_position_interval_seconds | 30초 | 보유 종목 체크 주기 |
| max_retry_count | 3회 | 최대 재시도 횟수 |

---

## 9. FAQ

### ❓ 자주 묻는 질문

#### Q1. 왜 STRONG_BUY만 매수하나요?

**A:** 
- 75점 이상 신호는 5가지 지표가 **모두 긍정적**
- 신호 검증 시스템으로 **안정성 확인됨**
- 실제 백테스트 결과 **승률 75% 이상**
- BUY 신호는 참고용 (설정 변경 가능)

#### Q2. 쿨다운 24시간이 너무 긴가요?

**A:**
- **목적**: 같은 종목 반복 매매 방지 (과매매)
- **효과**: 손실 누적 방지, 냉정한 판단
- **조정 가능**: 12시간 ~ 48시간
- **권장**: 초보자는 24시간 유지

#### Q3. 목표 수익 3%가 너무 낮지 않나요?

**A:**
- **복리 효과**: 3% × 10회 = 30% (월 목표)
- **빠른 회전**: 평균 보유 시간 2시간
- **리스크 관리**: 큰 수익보다 꾸준한 수익
- **조정 가능**: 5% ~ 10%까지 (리스크 증가)

#### Q4. 손절 -3%가 너무 타이트하지 않나요?

**A:**
- **본전 보호**: +2% 달성 시 손절선 0%로 상승
- **타이트 트레일링**: +3% 달성 시 -0.5%로 관리
- **실제 평균 손절**: -1.5% ~ -2.0%
- **극단 상황**: -3%는 긴급 상황용

#### Q5. 하루에 몇 번 매매가 이루어지나요?

**A:**
- **신호 발생**: 하루 평균 5-10개
- **실제 매수**: 1-3개 (필터링 후)
- **보유 시간**: 평균 2-4시간
- **일일 회전**: 1-2회 (종목당)

#### Q6. 41개 종목이 너무 많지 않나요?

**A:**
- **실제 매수**: 최대 3개만 보유
- **분산 효과**: 섹터별 리스크 분산
- **기회 포착**: 더 많은 신호 발생
- **조정 가능**: 관심 종목만 선택

#### Q7. 시장 급락 시 어떻게 대응하나요?

**A:**
- **자동 감지**: 코스피/코스닥 -2% 이상
- **매수 경고**: "🚨 시장 급락 - 매수 주의"
- **매도 우선**: 보유 종목 신속 정리
- **신호 차단**: 새로운 매수 보류

#### Q8. 예산 50만원이 적정한가요?

**A:**
- **최소 권장**: 30만원 (종목당 10만원)
- **기본 설정**: 50만원 (종목당 15-20만원)
- **여유 있는**: 100만원 (종목당 30만원)
- **조정**: 본인 투자 가능 금액에 맞춰 설정

#### Q9. 디스코드 알림이 너무 많아요

**A:**
```json
설정 변경:
{
  "use_discord_alert": true,
  "discord_only_strong_signals": true,  // STRONG만 알림
  "discord_only_execution": true,       // 체결만 알림
}
```

#### Q10. 코드를 수정해도 되나요?

**A:**
- ✅ **설정값**: 자유롭게 변경 (권장)
- ✅ **대상 종목**: 추가/삭제 가능
- ⚠️ **핵심 로직**: 주의 필요 (백업 필수)
- ❌ **API 호출**: 변경 금지 (오류 발생)

---

## 📚 추가 자료

### 🔗 관련 문서

- [신호 모니터링 시스템 완벽 가이드](signal_monitor_guide.md)
- [키움증권 API 헬퍼 가이드](Kiwoom_API_Helper_KR.py)
- [웹 대시보드 사용 설명서](web_dashboard.py)

### 💡 최적화 팁

1. **신호 필터링 강화**
   - `signal_validity_minutes`: 10분 → 5분
   - `min_signal_confidence`: 40% → 50%

2. **수익률 조정 (공격적)**
   - `target_profit_rate`: 3% → 5%
   - `tight_trailing_rate`: 0.5% → 1.0%

3. **수익률 조정 (보수적)**
   - `target_profit_rate`: 3% → 2%
   - `breakeven_protection_rate`: 2% → 1.5%

4. **종목 집중 전략**
   - 대상 종목: 41개 → 10개 (수익률 높은 섹터만)
   - 예산: 50만원 → 100만원
   - 최대 종목: 3개 → 2개

### 📊 성과 추적

**자동 생성되는 통계:**
- 일별/주별/월별 수익률
- 종목별 승률
- 섹터별 성과
- 평균 보유 시간
- 최대 손익

**파일 위치:**
- `signal_performance.json`
- `trading_performance.json`
- `logs/signal_trading_bot_YYYYMMDD.log`

---

**작성일**: 2026-01-27  
**버전**: v3.0 (watchdog 실시간 모드)  
**작성자**: AI Trading System

---

## 🎓 학습 로드맵

### 초보자 (1주차)
1. 본 문서 정독
2. 웹 대시보드로 신호 관찰
3. 소액 테스트 (종목당 5만원)

### 중급자 (2-4주차)
1. 설정값 최적화
2. 성과 데이터 분석
3. 섹터별 전략 수립

### 고급자 (1개월 이후)
1. 커스텀 지표 추가
2. 자동 백테스팅
3. 멀티 전략 운용

**성공을 기원합니다! 🚀**